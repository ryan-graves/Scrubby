name: Create Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.2)'
        required: true
      build:
        description: 'Build number (e.g., 11)'
        required: true

jobs:
  build-and-release:
    runs-on: macos-26
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '26.2'

      - name: Install Sparkle tools
        uses: jozefizso/setup-sparkle@c3942efd8f86094847bde548e95ad9de3eab23c7 # v2
        with:
          version: 2.8.1

      - name: Install Developer ID certificate
        env:
          DEVELOPER_ID_CERT_BASE64: ${{ secrets.DEVELOPER_ID_CERT_BASE64 }}
          DEVELOPER_ID_CERT_PASSWORD: ${{ secrets.DEVELOPER_ID_CERT_PASSWORD }}
        run: |
          # Create a temporary keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)

          # Create keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Decode and import certificate
          echo "$DEVELOPER_ID_CERT_BASE64" | base64 --decode > $RUNNER_TEMP/certificate.p12
          security import $RUNNER_TEMP/certificate.p12 \
            -P "$DEVELOPER_ID_CERT_PASSWORD" \
            -A \
            -t cert \
            -f pkcs12 \
            -k "$KEYCHAIN_PATH"

          # Add keychain to search list
          security list-keychain -d user -s "$KEYCHAIN_PATH"

          # Allow codesign to access the keychain
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Clean up certificate file
          rm -f $RUNNER_TEMP/certificate.p12

          # Verify the identity is available
          security find-identity -v -p codesigning "$KEYCHAIN_PATH"

      - name: Build app
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          xcodebuild -project FileScrubby.xcodeproj \
            -scheme FileScrubby \
            -configuration Release \
            -derivedDataPath ./build \
            CODE_SIGN_STYLE=Manual \
            CODE_SIGN_IDENTITY="Developer ID Application" \
            DEVELOPMENT_TEAM="$APPLE_TEAM_ID" \
            MACOSX_DEPLOYMENT_TARGET=26.0 \
            clean build

      - name: Verify code signature
        run: |
          echo "Verifying code signature..."
          codesign --verify --deep --strict --verbose=2 build/Build/Products/Release/FileScrubby.app
          echo ""
          echo "Code signature details:"
          codesign -dv --verbose=4 build/Build/Products/Release/FileScrubby.app

      - name: Create DMG
        run: |
          mkdir -p Releases/dmg-temp
          cp -R build/Build/Products/Release/FileScrubby.app Releases/dmg-temp/
          hdiutil create -volname "FileScrubby ${{ github.event.inputs.version }}" \
            -srcfolder Releases/dmg-temp \
            -ov -format UDZO \
            "Releases/FileScrubby-${{ github.event.inputs.version }}.dmg"
          rm -rf Releases/dmg-temp

      - name: Setup Sparkle private key
        run: |
          umask 077
          printf '%s' "${{ secrets.SPARKLE_PRIVATE_KEY }}" > sparkle_key

      - name: Generate appcast
        run: |
          if ! command -v generate_appcast >/dev/null 2>&1; then
            echo "Error: 'generate_appcast' not found in PATH."
            echo "Ensure Sparkle tools are installed (see 'Install Sparkle tools' step)."
            exit 1
          fi
          cd Releases
          generate_appcast --ed-key-file ../sparkle_key \
            --download-url-prefix "https://raw.githubusercontent.com/${{ github.repository }}/refs/heads/main/Releases/" \
            .

      - name: Cleanup secrets
        if: always()
        run: |
          rm -f sparkle_key
          security delete-keychain $RUNNER_TEMP/app-signing.keychain-db 2>/dev/null || true

      - name: Commit and push changes
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add Releases/
          git commit -m "Release version ${{ github.event.inputs.version }} (build ${{ github.event.inputs.build }})"
          git push origin main

      - name: Create GitHub Release
        uses: softprops/action-gh-release@26994186c0ac3ef5cae75ac16aa32e8153525f77 # v1
        with:
          tag_name: v${{ github.event.inputs.version }}
          name: FileScrubby ${{ github.event.inputs.version }}
          files: Releases/FileScrubby-${{ github.event.inputs.version }}.dmg
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
