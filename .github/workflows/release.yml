name: Create Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.2)'
        required: true
      build:
        description: 'Build number (e.g., 11)'
        required: true

jobs:
  build-and-release:
    runs-on: macos-26

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '26.2'

    - name: Install Sparkle tools
      uses: jozefizso/setup-sparkle@c3942efd8f86094847bde548e95ad9de3eab23c7 # v2
      with:
        version: 2.8.1

    - name: Build app
      run: |
        xcodebuild -project FileScrubby.xcodeproj \
          -scheme FileScrubby \
          -configuration Release \
          -derivedDataPath ./build \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          MACOSX_DEPLOYMENT_TARGET=26.0 \
          clean build

    - name: Create DMG
      run: |
        mkdir -p Releases/dmg-temp
        cp -R build/Build/Products/Release/FileScrubby.app Releases/dmg-temp/
        hdiutil create -volname "FileScrubby ${{ github.event.inputs.version }}" \
          -srcfolder Releases/dmg-temp \
          -ov -format UDZO \
          "Releases/FileScrubby-${{ github.event.inputs.version }}.dmg"
        rm -rf Releases/dmg-temp

    - name: Setup Sparkle private key
      run: |
        echo "${{ secrets.SPARKLE_PRIVATE_KEY }}" > sparkle_key

    - name: Generate appcast
      run: |
        if ! command -v generate_appcast >/dev/null 2>&1; then
          echo "Error: 'generate_appcast' not found in PATH."
          echo "Ensure Sparkle tools are installed (see 'Install Sparkle tools' step)."
          exit 1
        fi
        cd Releases
        generate_appcast --ed-key-file ../sparkle_key \
          --download-url-prefix "https://raw.githubusercontent.com/${{ github.repository }}/refs/heads/main/Releases/" \
          .

    - name: Cleanup Sparkle private key
      if: always()
      run: rm -f sparkle_key

    - name: Commit and push changes
      run: |
        git config user.name "GitHub Actions Bot"
        git config user.email "actions@github.com"
        git add Releases/
        git commit -m "Release version ${{ github.event.inputs.version }} (build ${{ github.event.inputs.build }})"
        git push origin main

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ github.event.inputs.version }}
        name: FileScrubby ${{ github.event.inputs.version }}
        files: Releases/FileScrubby-${{ github.event.inputs.version }}.dmg
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
